<?php
/**
 * File PentestController.php
 *
 * PHP Version 5.6
 *
 * @category  Class
 * @package   AppBundle\Tests\Controller
 * @author    mrgn <xyz@example.com>
 * @copyright 2016 mrgn
 * @license   MIT http://choosealicense.com/licenses/mit/
 * @link      http://lorem.ovh
 */

namespace AppBundle\Tests\Controller;

use AppBundle\Utils\Pentester\SqlPentester;
use AppBundle\Utils\Target\SqlTarget;
use Doctrine\Common\Annotations\Annotation\Target;
use Guzzle\Http\Client;
use Misd\GuzzleBundle\MisdGuzzleBundle;
use Symfony\Bundle\FrameworkBundle\Test\WebTestCase;

/**
 * Class SqlPentesterTest
 * @category  Class
 * @package AppBundle\Tests\Controller
 * @author    mrgn <xyz@example.com>
 * @copyright 2016 mrgn
 * @license   MIT http://choosealicense.com/licenses/mit/
 * @link      http://lorem.ovh
 */
class SqlPentesterTest extends WebTestCase
{
    /**
     * @var \Doctrine\ORM\EntityManager
     */
    private $em;

    /**
     * {@inheritDoc}
     */
    protected function setUp()
    {
        self::bootKernel();

        $this->em = static::$kernel->getContainer()
            ->get('doctrine')
            ->getManager();
    }

    public function testGetGosling()
    {
        $target = new SqlTarget();
        $target->setParameters(array(
            "user" => "admin",
            "password" => "123"
        ));
        $target->setUrl("www.evanpeuvergne.com/phpmyadmin");

        $repo = $this->em->getRepository('AppBundle:SqlError');;
        $sql_error = $repo->getSqlError();

        $this->assertNotNull($sql_error, "Echec");
        $this->assertNotNull($sql_error->getValue(), "Echec");

        // test if report has the variable $url and $used_sql_error
        $used_sql_error = $sql_error->getValue();
        $url = $target->getUrl();

        $this->assertNotNull($used_sql_error, "Echec");
        $this->assertNotNull($url, "Echec");

    }

    public function testChangeParamsToHackParams()
    {
        $target = new SqlTarget();
        $target->setParameters(array(
         "user" => "admin",
            "password" => null
        ));

        //create new uzzle client for testing purpose
        $guzzle = new MisdGuzzleBundle();
        //create new instance of our Sqlpentester
        $sqlPentester = new SqlPentester($guzzle, $this->em);

        //$values = $target->getParameters();

        // test this function replace the undefined parameters from target with sql strings from DB
        $repo = $this->em->getRepository('AppBundle:SqlError');;
        $sql_error = $repo->getSqlError();

        //do things now :D
        $perceval = $sqlPentester->changeParamsToHackParams($target, $sql_error);

        $this->assertNotNull($perceval["password"], "Echec de l'injection ");
    }
}
