<?php
/**
 * File FuzzPentester.php
 *
 * PHP Version 5.6
 *
 * @category  Class
 * @package   Zerowing
 * @author    mrgn <xyz@example.com>
 * @copyright 2016 mrgn
 * @license   MIT http://choosealicense.com/licenses/mit/
 * @link      http://lorem.ovh
 */

namespace AppBundle\Utils\Pentester;

use AppBundle\Utils\Reporter\Reporter;
use AppBundle\Utils\Target\TargetInterface;
use Doctrine\ORM\EntityManager;
use Guzzle\Http\Client;
use Misd\GuzzleBundle\MisdGuzzleBundle;

/**
 * Class FuzzPentester
 * @category  Class
 * @package AppBundle\Utils\Pentester
 * @author    mrgn <xyz@example.com>
 * @copyright 2016 mrgn
 * @license   MIT http://choosealicense.com/licenses/mit/
 * @link      http://lorem.ovh
 */
class FuzzPentester extends AbstractPentester
{

    /**
     * @var EntityManager
     */
    private $_em;

    /**
     * Automatically setting up a Reporter
     * FuzzPentester constructor.
     *
     * @param MisdGuzzleBundle $guzzle A guzzle client
     * @param EntityManager $em
     */
    public function __construct($guzzle, EntityManager $em)
    {
        parent::__construct($guzzle);
        $this->_em = $em;
        $this->_reporter = new Reporter("fuzz");
    }

    /**
     * @inheritdoc
     */
    public function test(TargetInterface $target)
    {
        $this->_guzzle->setBaseUrl($target->getUrl());
        $this->fuzzCommonUrls($target);
    }

    /**
     * Fuzzing URLs helps us finding system weaknesses
     * @param TargetInterface $target
     */
    public function fuzzCommonUrls(TargetInterface $target)
    {
        $uris = $this->_em->getRepository('AppBundle:FuzzingUri')->findAll();

        foreach ($uris as $one_uri) {
            $one_uri_string = $one_uri->getUri();

            $req = $this->_guzzle->get($one_uri_string);
            $res = $req->send();
            //todo verify 404 in text
            if (200 == $res->getStatusCode()) {
                $this->_reporter->report("Spotted ".$req->getUrl());
            }
        }
    }
}