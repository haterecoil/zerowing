<?php
/**
 * File PentestController.php
 *
 * PHP Version 5.6
 *
 * @category  Class
 * @package   AppBundle\Tests\Controller
 * @author    mrgn <xyz@example.com>
 * @copyright 2016 mrgn
 * @license   MIT http://choosealicense.com/licenses/mit/
 * @link      http://lorem.ovh
 */

namespace AppBundle\Tests\Controller;

use Guzzle\Http\Client;
use Guzzle\Plugin\Cookie\CookieJar\ArrayCookieJar;
use Guzzle\Plugin\Cookie\CookiePlugin;
use Symfony\Bundle\FrameworkBundle\Test\WebTestCase;

/**
 * Class PentestControllerTest
 * @category  Class
 * @package AppBundle\Tests\Controller
 * @author    mrgn <xyz@example.com>
 * @copyright 2016 mrgn
 * @license   MIT http://choosealicense.com/licenses/mit/
 * @link      http://lorem.ovh
 */
class PentestControllerTest extends WebTestCase
{

    /**
     * DVWA's url.
     * todo set in a config file
     * @var string
     */
    private $DVWA_URL = "http://localhost/hack/";

    /**
     * the regex to find the csrf token in login.php
     * @var string
     */
    private $USER_TOKEN_REGEX = "/name='user_token' value='([a-f0-9]{32})/";

    /**
     * @var Client
     */
    private $_dvwa_guzzle = null;

    /**
     * Inject Guzzle in this test class
     * And set up the given client for use on
     * Damn Vulnerable Web Application... A vulnerable application
     * without API...
     * Difficulty resided in finding the way of using
     * cookies and correct documentation for all methods.
     */
    public function __construct()
    {
        parent::__construct();

        //prepare a cookie jar
        $jar = new ArrayCookieJar();
        $cookiePlugin = new CookiePlugin($jar);

        //get a guzzle instance
        $this->_dvwa_guzzle = new Client();
        $this->_dvwa_guzzle->setBaseUrl($this->DVWA_URL);
        $this->_dvwa_guzzle->setUserAgent("Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.109 Safari/537.36");
        $this->_dvwa_guzzle->addSubscriber($cookiePlugin);

        //first request/response exchange to get CSRF token
        $request = $this->_dvwa_guzzle->get('login.php', null, ["allow_redirects" => false]);
        $response = $request->send();

        $str = $response->getBody();
        preg_match($this->USER_TOKEN_REGEX, $str, $matches);
        $user_token = $matches[1];

        //second exchange to login
        $request = $this->_dvwa_guzzle->createRequest(
            'POST',
            'login.php',
            null,
            [
                'username' => 'admin',
                'password' => 'password',
                'Login' => 'Login',
                'user_token' => $user_token,
            ],
            [
                "allow_redirects" => true,
            ]
        );

        $request->send();
    }

    /**
     * Test the PentestController->LeeroyJenkins
     *  Test for 200 HTTP response
     *
     * @return void
     */
    public function testSqlAction()
    {
        $client = static::createClient();
        $client->request('GET', '/pentest');

        $res = $client->getResponse()->isOk();
    }

    /**
     * Test the DVWA access setup (to be sure __construct worked well)
     */
    public function testDvwaAccessAction()
    {
        $this->assertNotNull($this->_dvwa_guzzle, "guzzle client Y U NO set up?");

        $uri = 'index.php';
        $res = $this->_dvwa_guzzle->get($uri)->send();

        $this->assertEquals(200, $res->getStatusCode(), "is the serv online ? URL defined ?");
        $this->assertEquals($this->DVWA_URL.$uri, $res->getEffectiveUrl(), "maybe not authed :/");
    }

}

